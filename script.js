// Complete Nepali alphabet data with examples
const nepaliAlphabets = {
    vowels: [
        { 
            letter: "अ", 
            examples: [
                {word: "अनार", meaning: "Pomegranate", highlighted: "अ"},
                {word: "अमृत", meaning: "Nectar", highlighted: "अ"},
                {word: "अङ्क", meaning: "Number", highlighted: "अ"}
            ],
            audio: "अ.m4a" 
        },
        { 
            letter: "आ", 
            examples: [
                {word: "आमा", meaning: "Mother", highlighted: "आ"},
                {word: "आकाश", meaning: "Sky", highlighted: "आ"},
                {word: "आँखा", meaning: "Eye", highlighted: "आ"}
            ],
            audio: "आ.m4a" 
        },
        { 
            letter: "इ", 
            examples: [
                {word: "इमान्दार", meaning: "Honest", highlighted: "इ"},
                {word: "इन्द्र", meaning: "God Indra", highlighted: "इ"},
                {word: "इच्छा", meaning: "Desire", highlighted: "इ"}
            ],
            audio: "इ.m4a" 
        },
        { 
            letter: "ई", 
            examples: [
                {word: "ईश्वर", meaning: "God", highlighted: "ई"},
                {word: "ईर्ष्या", meaning: "Jealousy", highlighted: "ई"},
                {word: "ईमान", meaning: "Integrity", highlighted: "ई"}
            ],
            audio: "ई.m4a" 
        },
        { 
            letter: "उ", 
            examples: [
                {word: "उकाली", meaning: "Uphill", highlighted: "उ"},
                {word: "उपहार", meaning: "Gift", highlighted: "उ"},
                {word: "उद्योग", meaning: "Industry", highlighted: "उ"}
            ],
            audio: "उ.m4a" 
        },
        { 
            letter: "ऊ", 
            examples: [
                {word: "ऊन", meaning: "Wool", highlighted: "ऊ"},
                {word: "ऊँचो", meaning: "High", highlighted: "ऊ"},
                {word: "ऊर्जा", meaning: "Energy", highlighted: "ऊ"}
            ],
            audio: "ऊ.m4a" 
        },
        { 
            letter: "ऋ", 
            examples: [
                {word: "ऋतु", meaning: "Season", highlighted: "ऋ"},
                {word: "ऋषि", meaning: "Sage", highlighted: "ऋ"},
                {word: "ऋण", meaning: "Debt", highlighted: "ऋ"}
            ],
            audio: "ऋ.m4a" 
        },
        { 
            letter: "ए", 
            examples: [
                {word: "एक", meaning: "One", highlighted: "ए"},
                {word: "एकता", meaning: "Unity", highlighted: "ए"},
                {word: "एकाइ", meaning: "Unit", highlighted: "ए"}
            ],
            audio: "ए.m4a" 
        },
        { 
            letter: "ऐ", 
            examples: [
                {word: "ऐनाखानी", meaning: "Mirror", highlighted: "ऐ"},
                {word: "ऐच्छिक", meaning: "Optional", highlighted: "ऐ"},
                {word: "ऐतिहासिक", meaning: "Historical", highlighted: "ऐ"}
            ],
            audio: "ऐ.m4a" 
        },
        { 
            letter: "ओ", 
            examples: [
                {word: "ओखर", meaning: "Stone", highlighted: "ओ"},
                {word: "ओझा", meaning: "Shaman", highlighted: "ओ"},
                {word: "ओठ", meaning: "Lip", highlighted: "ओ"}
            ],
            audio: "ओ.m4a" 
        },
        { 
            letter: "औ", 
            examples: [
                {word: "औंसी", meaning: "New moon", highlighted: "औ"},
                {word: "औषध", meaning: "Medicine", highlighted: "औ"},
                {word: "औलाद", meaning: "Offspring", highlighted: "औ"}
            ],
            audio: "औ.m4a" 
        },
        { 
            letter: "अं", 
            examples: [
                {word: "अंगूर", meaning: "Grapes", highlighted: "अं"},
                {word: "अंग्रेजी", meaning: "English", highlighted: "अं"},
                {word: "अंकुर", meaning: "Sprout", highlighted: "अं"}
            ],
            audio: "अं.m4a" 
        },
        { 
            letter: "अः", 
            examples: [
                {word: "अः", meaning: "Expression of pain", highlighted: "अः"}            ],
            audio: "अः.m4a" 
        }
    ],
    consonants: [
        { 
            letter: "क", 
            examples: [
                {word: "कमल", meaning: "Lotus", highlighted: "क"},
                {word: "किताब", meaning: "Book", highlighted: "क"},
                {word: "कागज", meaning: "Paper", highlighted: "क"}
            ],
            audio: "क.m4a" 
        },
        { 
            letter: "ख", 
            examples: [
                {word: "खरायो", meaning: "Rabbit", highlighted: "ख"},
                {word: "खुसी", meaning: "Happiness", highlighted: "ख"},
                {word: "खजुर", meaning: "Date fruit", highlighted: "ख"}
            ],
            audio: "ख.m4a" 
        },
        { 
            letter: "ग", 
            examples: [
                {word: "गाउँ", meaning: "Village", highlighted: "ग"},
                {word: "गजुर", meaning: "Pineapple", highlighted: "ग"},
                {word: "गरुड", meaning: "Eagle", highlighted: "ग"}
            ],
            audio: "ग.m4a" 
        },
        { 
            letter: "घ", 
            examples: [
                {word: "घर", meaning: "House", highlighted: "घ"},
                {word: "घण्टी", meaning: "Bell", highlighted: "घ"},
                {word: "घाम", meaning: "Sunshine", highlighted: "घ"}
            ],
            audio: "घ.m4a" 
        },
        { 
            letter: "ङ", 
            examples: [
                {word: "रङ", meaning: "Color", highlighted: "ङ"},
                {word: "चाङ", meaning: "Moon", highlighted: "ङ"},
                {word: "सङ्गीत", meaning: "Music", highlighted: "ङ"}
            ],
            audio: "ङ.m4a" 
        },
        { 
            letter: "च", 
            examples: [
                {word: "चरा", meaning: "Bird", highlighted: "च"},
                {word: "चिया", meaning: "Tea", highlighted: "च"},
                {word: "चश्मा", meaning: "Glasses", highlighted: "च"}
            ],
            audio: "च.m4a" 
        },
        { 
            letter: "छ", 
            examples: [
                {word: "छाता", meaning: "Umbrella", highlighted: "छ"},
                {word: "छोरो", meaning: "Son", highlighted: "छ"},
                {word: "छाप", meaning: "Print", highlighted: "छ"}
            ],
            audio: "छ.m4a" 
        },
        { 
            letter: "ज", 
            examples: [
                {word: "जनावर", meaning: "Animal", highlighted: "ज"},
                {word: "जुत्ता", meaning: "Shoes", highlighted: "ज"},
                {word: "जन्ती", meaning: "Caravan", highlighted: "ज"}
            ],
            audio: "ज.m4a" 
        },
        { 
            letter: "झ", 
            examples: [
                {word: "झरना", meaning: "Waterfall", highlighted: "झ"},
                {word: "झण्डा", meaning: "Flag", highlighted: "झ"},
                {word: "झलक", meaning: "Glimpse", highlighted: "झ"}
            ],
            audio: "झ.m4a" 
        },
        { 
            letter: "ञ", 
            examples: [
                {word: "पञ्च", meaning: "Five", highlighted: "ञ"},
                {word: "चञ्चल", meaning: "Restless", highlighted: "ञ"},
                {word: "विज्ञान", meaning: "Science", highlighted: "ञ"}
            ],
            audio: "ञ.m4a" 
        },
        { 
            letter: "ट", 
            examples: [
                {word: "टोपी", meaning: "Cap", highlighted: "ट"},
                {word: "टमाटर", meaning: "Tomato", highlighted: "ट"},
                {word: "टेबुल", meaning: "Table", highlighted: "ट"}
            ],
            audio: "ट.m4a" 
        },
        { 
            letter: "ठ", 
            examples: [
                {word: "ठूलो", meaning: "Big", highlighted: "ठ"},
                {word: "ठेगाना", meaning: "Address", highlighted: "ठ"},
                {word: "ठोक्नु", meaning: "To knock", highlighted: "ठ"}
            ],
            audio: "ठ.m4a" 
        },
        { 
            letter: "ड", 
            examples: [
                {word: "डल्ले", meaning: "Stupid", highlighted: "ड"},
                {word: "डर", meaning: "Fear", highlighted: "ड"},
                {word: "डोरी", meaning: "String", highlighted: "ड"}
            ],
            audio: "ड.m4a" 
        },
        { 
            letter: "ढ", 
            examples: [
                {word: "ढुङ्गा", meaning: "Stone", highlighted: "ढ"},
                {word: "ढोका", meaning: "Door", highlighted: "ढ"},
                {word: "ढाल", meaning: "Shield", highlighted: "ढ"}
            ],
            audio: "ढ.m4a" 
        },
        { 
            letter: "ण", 
            examples: [
                {word: "गणेश", meaning: "Lord Ganesh", highlighted: "ण"},
                {word: "प्रणाम", meaning: "Greeting", highlighted: "ण"},
                {word: "अण्डा", meaning: "Egg", highlighted: "ण"}
            ],
            audio: "ण.m4a" 
        },
        { 
            letter: "त", 
            examples: [
                {word: "तारा", meaning: "Star", highlighted: "त"},
                {word: "तरकारी", meaning: "Vegetables", highlighted: "त"},
                {word: "तितो", meaning: "Bitter", highlighted: "त"}
            ],
            audio: "त.m4a" 
        },
        { 
            letter: "थ", 
            examples: [
                {word: "थैली", meaning: "Bag", highlighted: "थ"},
                {word: "थुप्रै", meaning: "Many", highlighted: "थ"},
                {word: "थाक", meaning: "Tired", highlighted: "थ"}
            ],
            audio: "थ.m4a" 
        },
        { 
            letter: "द", 
            examples: [
                {word: "दही", meaning: "Yogurt", highlighted: "द"},
                {word: "दुध", meaning: "Milk", highlighted: "द"},
                {word: "दाजु", meaning: "Elder brother", highlighted: "द"}
            ],
            audio: "द.m4a" 
        },
        { 
            letter: "ध", 
            examples: [
                {word: "धन", meaning: "Wealth", highlighted: "ध"},
                {word: "धागो", meaning: "Thread", highlighted: "ध"},
                {word: "धेरै", meaning: "Many", highlighted: "ध"}
            ],
            audio: "ध.m4a" 
        },
        { 
            letter: "न", 
            examples: [
                {word: "नदी", meaning: "River", highlighted: "न"},
                {word: "नमस्ते", meaning: "Hello", highlighted: "न"},
                {word: "नानी", meaning: "Grandmother", highlighted: "न"}
            ],
            audio: "न.m4a" 
        },
        { 
            letter: "प", 
            examples: [
                {word: "पानी", meaning: "Water", highlighted: "प"},
                {word: "पुस्तक", meaning: "Book", highlighted: "प"},
                {word: "पाखा", meaning: "Fan", highlighted: "प"}
            ],
            audio: "प.m4a" 
        },
        { 
            letter: "फ", 
            examples: [
                {word: "फूल", meaning: "Flower", highlighted: "फ"},
                {word: "फर्कनु", meaning: "To return", highlighted: "फ"},
                {word: "फल", meaning: "Fruit", highlighted: "फ"}
            ],
            audio: "फ.m4a" 
        },
        { 
            letter: "ब", 
            examples: [
                {word: "बाटो", meaning: "Path", highlighted: "ब"},
                {word: "बिरालो", meaning: "Cat", highlighted: "ब"},
                {word: "बत्ती", meaning: "Lamp", highlighted: "ब"}
            ],
            audio: "ब.m4a" 
        },
        { 
            letter: "भ", 
            examples: [
                {word: "भात", meaning: "Rice", highlighted: "भ"},
                {word: "भाइ", meaning: "Brother", highlighted: "भ"},
                {word: "भान्जा", meaning: "Nephew", highlighted: "भ"}
            ],
            audio: "भ.m4a" 
        },
        { 
            letter: "म", 
            examples: [
                {word: "माया", meaning: "Love", highlighted: "म"},
                {word: "मकै", meaning: "Corn", highlighted: "म"},
                {word: "मुटु", meaning: "Heart", highlighted: "म"}
            ],
            audio: "म.m4a" 
        },
        { 
            letter: "य", 
            examples: [
                {word: "यात्रा", meaning: "Journey", highlighted: "य"},
                {word: "याद", meaning: "Memory", highlighted: "य"},
                {word: "योग", meaning: "Yoga", highlighted: "य"}
            ],
            audio: "य.m4a" 
        },
        { 
            letter: "र", 
            examples: [
                {word: "राम्रो", meaning: "Good", highlighted: "र"},
                {word: "रुख", meaning: "Tree", highlighted: "र"},
                {word: "रातो", meaning: "Red", highlighted: "र"}
            ],
            audio: "र.m4a" 
        },
        { 
            letter: "ल", 
            examples: [
                {word: "लत्ता", meaning: "Cloth", highlighted: "ल"},
                {word: "लौरो", meaning: "Stick", highlighted: "ल"},
                {word: "लामो", meaning: "Long", highlighted: "ल"}
            ],
            audio: "ल.m4a" 
        },
        { 
            letter: "व", 
            examples: [
                {word: "वन", meaning: "Forest", highlighted: "व"},
                {word: "विद्या", meaning: "Knowledge", highlighted: "व"},
                {word: "वस्तु", meaning: "Thing", highlighted: "व"}
            ],
            audio: "व.m4a" 
        },
        { 
            letter: "श", 
            examples: [
                {word: "शान्ति", meaning: "Peace", highlighted: "श"},
                {word: "शिक्षा", meaning: "Education", highlighted: "श"},
                {word: "शुभ", meaning: "Auspicious", highlighted: "श"}
            ],
            audio: "श.m4a" 
        },
        { 
            letter: "ष", 
            examples: [
                {word: "षट्कोण", meaning: "Hexagon", highlighted: "ष"},
                {word: "षड्यन्त्र", meaning: "Conspiracy", highlighted: "ष"},
                {word: "षष्ठ", meaning: "Sixth", highlighted: "ष"}
            ],
            audio: "ष.m4a" 
        },
        { 
            letter: "स", 
            examples: [
                {word: "सूर्य", meaning: "Sun", highlighted: "स"},
                {word: "सपना", meaning: "Dream", highlighted: "स"},
                {word: "सानो", meaning: "Small", highlighted: "स"}
            ],
            audio: "स.m4a" 
        },
        { 
            letter: "ह", 
            examples: [
                {word: "हात", meaning: "Hand", highlighted: "ह"},
                {word: "हिमाल", meaning: "Mountain", highlighted: "ह"},
                {word: "हरियो", meaning: "Green", highlighted: "ह"}
            ],
            audio: "ह.m4a" 
        },
        { 
            letter: "क्ष", 
            examples: [
                {word: "क्षेत्र", meaning: "Field", highlighted: "क्ष"},
                {word: "क्षमता", meaning: "Capacity", highlighted: "क्ष"},
                {word: "क्षत्रिय", meaning: "Warrior caste", highlighted: "क्ष"}
            ],
            audio: "क्ष.m4a" 
        },
        { 
            letter: "त्र", 
            examples: [
                {word: "त्रिशूल", meaning: "Trident", highlighted: "त्र"},
                {word: "त्रुटि", meaning: "Error", highlighted: "त्र"},
                {word: "त्रास", meaning: "Trouble", highlighted: "त्र"}
            ],
            audio: "त्र.m4a" 
        },
        { 
            letter: "ज्ञ", 
            examples: [
                {word: "ज्ञान", meaning: "Knowledge", highlighted: "ज्ञ"},
                {word: "विज्ञान", meaning: "Science", highlighted: "ज्ञ"},
                {word: "यज्ञ", meaning: "Sacrifice", highlighted: "ज्ञ"}
            ],
            audio: "ज्ञ.m4a" 
        }
    ]
};

// Global variables
let currentAudio = null;
let isPlayingAll = false;

// DOM elements
const vowelsGrid = document.getElementById('vowels-grid');
const consonantsGrid = document.getElementById('consonants-grid');
const playAllVowelsBtn = document.getElementById('playAllVowels');
const playAllConsonantsBtn = document.getElementById('playAllConsonants');
const downloadVowelsBtn = document.getElementById('downloadVowels');
const downloadConsonantsBtn = document.getElementById('downloadConsonants');
const resetPlayAllBtn = document.getElementById('resetPlayAll');
const resetExamplesBtn = document.getElementById('resetExamples');

// Initialize the alphabet buttons
function initAlphabetButtons() {
    // Create vowel buttons
    nepaliAlphabets.vowels.forEach(vowel => {
        const button = createLetterButton(vowel, 'vowels');
        vowelsGrid.appendChild(button);
    });
    
    // Create consonant buttons
    nepaliAlphabets.consonants.forEach(consonant => {
        const button = createLetterButton(consonant, 'consonants');
        consonantsGrid.appendChild(button);
    });
}

function createLetterButton(letterData, type) {
    const button = document.createElement('button');
    button.className = 'letter-btn';
    button.innerHTML = `
        <div class="letter-main">${letterData.letter}</div>
        <div class="examples-container"></div>
    `;
    button.dataset.letter = letterData.letter;
    button.dataset.audio = letterData.audio;
    button.dataset.type = type;
    
    button.addEventListener('click', () => {
        if (isPlayingAll) return;
        stopCurrentAudio();
        playLetterSound(letterData.audio);
        showExamples(button, letterData.examples);
        highlightLetter(button);
    });
    
    return button;
}

// Show examples for a letter (persistent)
function showExamples(button, examples) {
    const examplesContainer = button.querySelector('.examples-container');
    examplesContainer.innerHTML = '';
    
    examples.forEach(example => {
        const exampleDiv = document.createElement('div');
        exampleDiv.className = 'example-word';
        
        // Find position of highlighted letter
        const highlightPos = example.word.indexOf(example.highlighted);
        const before = example.word.substring(0, highlightPos);
        const after = example.word.substring(highlightPos + example.highlighted.length);
        
        exampleDiv.innerHTML = `
            ${before}<span class="highlighted-letter">${example.highlighted}</span>${after}
            <span class="example-meaning"> - ${example.meaning}</span>
        `;
        
        examplesContainer.appendChild(exampleDiv);
    });
}

// Reset all examples
function resetExamples() {
    document.querySelectorAll('.examples-container').forEach(container => {
        container.innerHTML = '';
    });
}

// Stop current audio if playing
function stopCurrentAudio() {
    if (currentAudio) {
        isPlayingAll = false;
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
}

// Play letter sound
function playLetterSound(audioFile) {
    stopCurrentAudio();
    currentAudio = new Audio(`audio/${audioFile}`);
    currentAudio.play().catch(e => console.error("Audio playback failed:", e));
}

// Highlight letter button temporarily
function highlightLetter(button) {
    // Remove highlight from all buttons first
    document.querySelectorAll('.letter-btn').forEach(btn => {
        btn.classList.remove('highlight');
    });
    
    // Add highlight to the clicked button
    button.classList.add('highlight');
    setTimeout(() => {
        button.classList.remove('highlight');
    }, 1000);
}

// Play all letters in sequence
async function playAllLetters(letters) {
    stopCurrentAudio();
    if (isPlayingAll) return;
    
    isPlayingAll = true;
    const buttons = Array.from(document.querySelectorAll('.letter-btn'));
    
    for (const letter of letters) {
        const button = buttons.find(btn => btn.dataset.letter === letter.letter);
        if (button) {
            // Highlight the button
            button.classList.add('highlight');
            
            // Show examples
            showExamples(button, letter.examples);
            
            // Play sound
            stopCurrentAudio();
            currentAudio = new Audio(`audio/${letter.audio}`);
            await new Promise((resolve) => {
                currentAudio.play().catch(e => console.error("Audio playback failed:", e));
                currentAudio.onended = resolve;
            });
            
            // Remove highlight after short delay
            await new Promise(resolve => setTimeout(resolve, 500));
            button.classList.remove('highlight');
        }
    }
    
    isPlayingAll = false;
}

// Generate PDF for practice sheets
function generatePracticePDF(type) {
    try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) throw new Error("jsPDF library not loaded");
        
        const doc = new jsPDF();
        const letters = type === 'vowels' ? nepaliAlphabets.vowels : nepaliAlphabets.consonants;
        const title = type === 'vowels' ? 'Devanagari Vowels Practice Sheet' : 'Devanagari Consonants Practice Sheet';

        // Page layout settings
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        const boxSize = 15;
        const boxesPerLetter = 10;
        const spacing = 2;
        let xPos = margin;
        let yPos = margin + 15;

        // Add title
        doc.setFontSize(18);
        doc.text(title, pageWidth/2, 10, { align: 'center' });

        // Add instructions
        doc.setFontSize(10);
        doc.text('Write each letter in the boxes, using the first box as example', 
                pageWidth/2, 17, { align: 'center', maxWidth: 180 });

        // Create practice sheets
        letters.forEach((letter, index) => {
            // Check if we need a new page (allow 40mm at bottom)
            if (yPos > doc.internal.pageSize.getHeight() - 30) {
                doc.addPage();
                yPos = margin;
            }

            // Calculate total width needed
            const totalWidth = boxSize * boxesPerLetter + spacing * (boxesPerLetter - 1);
            
            // Letter label (centered above boxes)
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.font = '60px Noto Sans Devanagari, Arial Unicode MS, sans-serif';
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(letter.letter, 50, 50);
            
            // Create practice boxes
            for (let i = 0; i < boxesPerLetter; i++) {
                const boxX = xPos + i * (boxSize + spacing);
                
                // Draw box
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.3);
                doc.rect(boxX, yPos, boxSize, boxSize);
                
                // Add example letter to first box
                if (i === 0) {
                    const letterCanvas = document.createElement('canvas');
                    letterCanvas.width = 80;
                    letterCanvas.height = 80;
                    const letterCtx = letterCanvas.getContext('2d');
                    letterCtx.font = '50px Noto Sans Devanagari, Arial Unicode MS, sans-serif';
                    letterCtx.fillStyle = '#000000';
                    letterCtx.textAlign = 'center';
                    letterCtx.textBaseline = 'middle';
                    letterCtx.fillText(letter.letter, 40, 40);
                    
                    doc.addImage(letterCanvas.toDataURL(), 'PNG', 
                               boxX + boxSize/2 - 6, 
                               yPos + boxSize/2 - 6, 
                               12, 12);
                }
            }

            // Move to next line (row)
            yPos += boxSize + 10;
            
            // Reset x position for next row
            xPos = margin;
        });

        doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
        
    } catch (error) {
        console.error('PDF generation error:', error);
        alert('Failed to generate PDF. Please try again.');
    }
}

// Check if PDF library is loaded
function checkPDFLibrary() {
    if (typeof window.jspdf === 'undefined') {
        console.error('jsPDF library not loaded');
        alert('PDF generation requires jsPDF library. Please ensure it is loaded.');
        return false;
    }
    return true;
}

// Event listeners
playAllVowelsBtn.addEventListener('click', () => playAllLetters(nepaliAlphabets.vowels));
playAllConsonantsBtn.addEventListener('click', () => playAllLetters(nepaliAlphabets.consonants));
downloadVowelsBtn.addEventListener('click', () => {
    if (checkPDFLibrary()) generatePracticePDF('vowels');
});
downloadConsonantsBtn.addEventListener('click', () => {
    if (checkPDFLibrary()) generatePracticePDF('consonants');
});
resetPlayAllBtn.addEventListener('click', () => stopCurrentAudio());
resetExamplesBtn.addEventListener('click', () => resetExamples());

// Mobile menu toggle
document.addEventListener('DOMContentLoaded', function() {
    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');
    
    if (hamburger && navMenu) {
        hamburger.addEventListener('click', () => {
            navMenu.classList.toggle('active');
        });
        
        // Close menu when clicking on a link
        document.querySelectorAll('.nav-menu a').forEach(link => {
            link.addEventListener('click', () => {
                navMenu.classList.remove('active');
            });
        });
    }
    
    // Initialize alphabet buttons
    initAlphabetButtons();
});